{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "vmName": {
      "type": "string",
      "metadata": {
        "description": "Name of the virtual machine. Also used as the DNS prefix."
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "azureuser",
      "metadata": {
        "description": "SSH admin username for the VM."
      }
    },
    "authenticationType": {
      "type": "string",
      "defaultValue": "sshPublicKey",
      "allowedValues": [
        "sshPublicKey",
        "password"
      ],
      "metadata": {
        "description": "Authentication type for the VM."
      }
    },
    "adminPasswordOrKey": {
      "type": "securestring",
      "metadata": {
        "description": "SSH public key or password for the VM."
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_B1s",
      "metadata": {
        "description": "Size of the virtual machine."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "mailDomain": {
      "type": "string",
      "metadata": {
        "description": "The mail domain for the email server (e.g. example.com). Set this to match your DNS if you have one, or use the Azure DNS FQDN."
      }
    }
  },
  "variables": {
    "vnetName": "[concat(parameters('vmName'), '-vnet')]",
    "subnetName": "default",
    "nsgName": "[concat(parameters('vmName'), '-nsg')]",
    "publicIpName": "[concat(parameters('vmName'), '-pip')]",
    "nicName": "[concat(parameters('vmName'), '-nic')]",
    "dnsLabelPrefix": "[toLower(parameters('vmName'))]",
    "linuxConfiguration": {
      "disablePasswordAuthentication": true,
      "ssh": {
        "publicKeys": [
          {
            "path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]",
            "keyData": "[parameters('adminPasswordOrKey')]"
          }
        ]
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2023-04-01",
      "name": "[variables('nsgName')]",
      "location": "[parameters('location')]",
      "properties": {
        "securityRules": [
          {
            "name": "Allow-SSH",
            "properties": {
              "priority": 1000,
              "direction": "Inbound",
              "access": "Allow",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "22",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "Allow-HTTP",
            "properties": {
              "priority": 1010,
              "direction": "Inbound",
              "access": "Allow",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "80",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "Allow-HTTPS",
            "properties": {
              "priority": 1020,
              "direction": "Inbound",
              "access": "Allow",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "443",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "Allow-SMTP",
            "properties": {
              "priority": 1030,
              "direction": "Inbound",
              "access": "Allow",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "25",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "Allow-SMTP-Submission",
            "properties": {
              "priority": 1040,
              "direction": "Inbound",
              "access": "Allow",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "587",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "Allow-IMAP",
            "properties": {
              "priority": 1050,
              "direction": "Inbound",
              "access": "Allow",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "143",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2023-04-01",
      "name": "[variables('publicIpName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Basic"
      },
      "properties": {
        "publicIPAllocationMethod": "Dynamic",
        "dnsSettings": {
          "domainNameLabel": "[variables('dnsLabelPrefix')]"
        }
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2023-04-01",
      "name": "[variables('vnetName')]",
      "location": "[parameters('location')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "10.0.0.0/16"
          ]
        },
        "subnets": [
          {
            "name": "[variables('subnetName')]",
            "properties": {
              "addressPrefix": "10.0.0.0/24"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-04-01",
      "name": "[variables('nicName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]",
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetName'))]"
              },
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
              }
            }
          }
        ],
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-03-01",
      "name": "[parameters('vmName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('vmSize')]"
        },
        "osProfile": {
          "computerName": "[parameters('vmName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'sshPublicKey'), variables('linuxConfiguration'), json('null'))]",
          "adminPassword": "[if(equals(parameters('authenticationType'), 'password'), parameters('adminPasswordOrKey'), json('null'))]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Canonical",
            "offer": "0001-com-ubuntu-server-jammy",
            "sku": "22_04-lts-gen2",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "FromImage",
            "managedDisk": {
              "storageAccountType": "Standard_LRS"
            }
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2023-03-01",
      "name": "[concat(parameters('vmName'), '/setup-email')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.1",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "script": "[base64(concat('#!/bin/bash\nset -euo pipefail\nexec > /var/log/email-setup.log 2>&1\n\nMAIL_DOMAIN=\"', parameters('mailDomain'), '\"\nHOSTNAME_FQDN=\"', parameters('vmName'), '.', parameters('mailDomain'), '\"\n\nexport DEBIAN_FRONTEND=noninteractive\n\n# Set hostname\nhostnamectl set-hostname \"$HOSTNAME_FQDN\"\necho \"127.0.0.1 $HOSTNAME_FQDN ', parameters('vmName'), '\" >> /etc/hosts\n\n# Pre-seed postfix answers\ndebconf-set-selections <<EOF\npostfix postfix/mailname string $MAIL_DOMAIN\npostfix postfix/main_mailer_type select Internet Site\nEOF\n\napt-get update\napt-get install -y postfix dovecot-imapd dovecot-lmtpd apache2 php php-xml php-mbstring php-intl php-zip php-json php-gd php-curl php-pear php-net-smtp php-net-idna2 php-mail-mime php-net-ldap3 php-imagick libapache2-mod-php mariadb-server roundcube roundcube-mysql roundcube-plugins\n\n# Create ashley user with a simple password\nid ashley &>/dev/null || useradd -m -s /bin/bash ashley\necho \"ashley:ashley\" | chpasswd\n\n# ---- Postfix Configuration ----\ncat > /etc/postfix/main.cf <<POSTFIXCF\nsmtpd_banner = \\$myhostname ESMTP\nbiff = no\nappend_dot_mydomain = no\nreadme_directory = no\ncompatibility_level = 3.6\n\nsmtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem\nsmtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key\nsmtpd_tls_security_level=may\n\nsmtp_tls_CApath=/etc/ssl/certs\nsmtp_tls_security_level=may\nsmtp_tls_session_cache_database = btree:\\${data_directory}/smtp_scache\n\nsmtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination\nmyhostname = $HOSTNAME_FQDN\nmydomain = $MAIL_DOMAIN\nalias_maps = hash:/etc/aliases\nalias_database = hash:/etc/aliases\nmyorigin = \\$mydomain\nmydestination = \\$myhostname, \\$mydomain, localhost.\\$mydomain, localhost\nrelayhost =\nmynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128\nmailbox_transport = lmtp:unix:private/dovecot-lmtp\ninet_interfaces = all\ninet_protocols = all\nrecipient_delimiter = +\n\n# Allow unauthenticated sending from localhost for Roundcube\nsmtpd_sasl_auth_enable = no\nPOSTFIXCF\n\n# Enable submission port (587) for sending\nif ! grep -q \"^submission\" /etc/postfix/master.cf; then\n  cat >> /etc/postfix/master.cf <<MASTERCF\nsubmission inet n       -       y       -       -       smtpd\n  -o syslog_name=postfix/submission\n  -o smtpd_tls_security_level=may\n  -o smtpd_sasl_auth_enable=no\n  -o smtpd_relay_restrictions=permit_mynetworks,reject\n  -o milter_macro_daemon_name=ORIGINATING\nMASTERCF\nfi\n\n# ---- Dovecot Configuration ----\ncat > /etc/dovecot/conf.d/10-mail.conf <<DOVECOTMAIL\nmail_location = maildir:~/Maildir\nnamespace inbox {\n  inbox = yes\n}\nDOVECOTMAIL\n\ncat > /etc/dovecot/conf.d/10-auth.conf <<DOVECOTAUTH\ndisable_plaintext_auth = no\nauth_mechanisms = plain login\n!include auth-system.conf.ext\nDOVECOTAUTH\n\ncat > /etc/dovecot/conf.d/10-master.conf <<DOVECOTMASTER\nservice imap-login {\n  inet_listener imap {\n    port = 143\n  }\n}\n\nservice lmtp {\n  unix_listener /var/spool/postfix/private/dovecot-lmtp {\n    mode = 0600\n    user = postfix\n    group = postfix\n  }\n}\n\nservice auth {\n  unix_listener auth-userdb {\n    mode = 0666\n  }\n}\nDOVECOTMASTER\n\n# ---- Roundcube Configuration ----\n# Generate a random DES key\nDES_KEY=$(openssl rand -base64 24 | head -c 24)\n\n# Configure roundcube database (sqlite for simplicity)\ncat > /etc/roundcube/config.inc.php <<RCCONFIG\n<?php\n\\$config = array();\n\\$config[\"db_dsnw\"] = \"sqlite:////var/lib/roundcube/roundcube.db\";\n\\$config[\"default_host\"] = \"localhost\";\n\\$config[\"default_port\"] = 143;\n\\$config[\"smtp_host\"] = \"localhost\";\n\\$config[\"smtp_port\"] = 25;\n\\$config[\"smtp_user\"] = \"\";\n\\$config[\"smtp_pass\"] = \"\";\n\\$config[\"support_url\"] = \"\";\n\\$config[\"product_name\"] = \"Azure Email\";\n\\$config[\"des_key\"] = \"$DES_KEY\";\n\\$config[\"plugins\"] = array();\n\\$config[\"language\"] = \"en_US\";\n\\$config[\"skin\"] = \"elastic\";\n\n// Auto-login as ashley - no authentication required\n\\$config[\"auto_login\"] = true;\n\\$config[\"login_autocomplete\"] = 2;\nRCCONFIG\n\n# Create the Roundcube SQLite DB directory\nmkdir -p /var/lib/roundcube\ntouch /var/lib/roundcube/roundcube.db\nchown -R www-data:www-data /var/lib/roundcube\n\n# Initialize roundcube DB\nif [ -f /usr/share/roundcube/SQL/sqlite.initial.sql ]; then\n  sqlite3 /var/lib/roundcube/roundcube.db < /usr/share/roundcube/SQL/sqlite.initial.sql 2>/dev/null || true\nelif [ -f /usr/share/roundcube/SQL/sqlite/2020071300.sql ]; then\n  for f in /usr/share/roundcube/SQL/sqlite/*.sql; do\n    sqlite3 /var/lib/roundcube/roundcube.db < \"$f\" 2>/dev/null || true\n  done\nfi\nchown www-data:www-data /var/lib/roundcube/roundcube.db\n\n# Apache config for Roundcube with auto-login\ncat > /etc/apache2/sites-available/roundcube.conf <<APACHECONF\n<VirtualHost *:80>\n    ServerAdmin admin@$MAIL_DOMAIN\n    DocumentRoot /var/lib/roundcube/public_html\n    ServerName $HOSTNAME_FQDN\n\n    Alias / /var/lib/roundcube/public_html/\n\n    <Directory /var/lib/roundcube/public_html/>\n        Options +FollowSymLinks\n        AllowOverride All\n        Require all granted\n    </Directory>\n\n    <Directory /var/lib/roundcube/config>\n        Require all denied\n    </Directory>\n\n    ErrorLog \\${APACHE_LOG_DIR}/roundcube_error.log\n    CustomLog \\${APACHE_LOG_DIR}/roundcube_access.log combined\n</VirtualHost>\nAPACHECONF\n\n# Create auto-login index.php\nmkdir -p /var/lib/roundcube/public_html\ncat > /var/lib/roundcube/public_html/index.php <<AUTOLOGIN\n<?php\ndefine(\"INSTALL_PATH\", \"/usr/share/roundcube/\");\nrequire_once INSTALL_PATH . \"program/include/iniset.php\";\n\\$rcmail = rcmail::get_instance();\nif (!\\$rcmail->user || !\\$rcmail->user->ID) {\n    \\$auth = \\$rcmail->plugins->exec_hook(\"authenticate\", array(\n        \"host\" => \"localhost\",\n        \"user\" => \"ashley\",\n        \"pass\" => \"ashley\",\n        \"cookiecheck\" => false,\n        \"valid\" => true,\n    ));\n    \\$rcmail->login(\\$auth[\"user\"], \\$auth[\"pass\"], \\$auth[\"host\"], false);\n    \\$rcmail->session->remove(\"temp\");\n    \\$rcmail->session->regenerate_id(false);\n    header(\"Location: /?_task=mail\");\n    exit;\n}\nrequire_once INSTALL_PATH . \"index.php\";\nAUTOLOGIN\n\n# Symlink roundcube assets so the app works from public_html\nfor item in /usr/share/roundcube/*; do\n  base=$(basename \"$item\")\n  [ \"$base\" = \"index.php\" ] && continue\n  ln -sf \"$item\" \"/var/lib/roundcube/public_html/$base\" 2>/dev/null || true\ndone\n\nchown -R www-data:www-data /var/lib/roundcube/public_html\n\na2dissite 000-default.conf 2>/dev/null || true\na2ensite roundcube.conf\na2enmod rewrite\n\n# Ensure services are enabled to start on boot\nsystemctl enable postfix\nsystemctl enable dovecot\nsystemctl enable apache2\nsystemctl enable mariadb 2>/dev/null || true\n\n# Restart all services\nsystemctl restart postfix\nsystemctl restart dovecot\nsystemctl restart apache2\n\n# Create Maildir for ashley\nsu - ashley -c \"mkdir -p ~/Maildir/{new,cur,tmp}\"\n\n# Send a test email to ashley\necho \"Welcome to your Azure email server!\" | mail -s \"Welcome\" ashley@$MAIL_DOMAIN 2>/dev/null || true\n\necho \"Email setup complete at $(date)\"\n'))]"
        }
      }
    }
  ],
  "outputs": {
    "fqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))).dnsSettings.fqdn]"
    },
    "publicIpAddress": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))).ipAddress]"
    },
    "webmailUrl": {
      "type": "string",
      "value": "[concat('http://', reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))).dnsSettings.fqdn)]"
    },
    "sshCommand": {
      "type": "string",
      "value": "[concat('ssh ', parameters('adminUsername'), '@', reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))).dnsSettings.fqdn)]"
    }
  }
}
